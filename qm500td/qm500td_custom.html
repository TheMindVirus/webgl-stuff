<title>Avolites QM500-TD BBC BECG LO6 CMCR20 EHX86V</title>
<script>
var channels = 512;
var universe = [];
var fixtures = [];
var states = [];
var focus = [];
var solo = [];
var keypad = "";
var edit = 255;
var clear = 0;
var enter = 0;
var video_page = 0;
var serial = null;
var encoder = null;
var writer = null;
var mastering_cue = 0.00;
var mastering_add = 0.00;
var mastering_swop = 0.00;
var mastering_grand = 1.00;
var manual_override = false;

var personality =
{
    0: "intensity", //start_code
    1: "red",
    2: "green",
    3: "blue",
};

var encode = function(data)
{
    var buffer = new ArrayBuffer(data.length);
    var view = new Uint8Array(buffer);
    for (var i = 0; i < data.length; ++i)
    {
        view[i] = data[i] & 0xFF;
    }
    return buffer;
}
var connect = function()
{
    navigator.serial.requestPort().then(function(port)
    {
        port.onconnect = function()
        {
            console.log("[INFO]", "connected", port);
            writer = port.writable.getWriter();
            serial = port;
        }
        port.ondisconnect = function() { console.log("[INFO]", "disconnected"); writer = null; }
        var options =
        {
            baudRate: document.getElementById("baud-rate").value,
            flowControl: "none", //"hardware",
            dataBits: 8,
            stopBits: 2,
            parity: "none",
        };
        port.open(options).then(function()
        {
            port.onconnect();
        });
    });
}
var editor = function()
{
    edit = parseInt(document.getElementById("edit-full").value);
}
var tester = function()
{
    var text = document.getElementById("test-text").value;
    manual_override = true;
    alert(text);
    var data = Array(1 + channels);
    data[0] = 0x00;
    data[1] = 0x00;
    data[2] = 0x00;
    data[3] = 0x00;
    data[4] = 0xFF;
    writer.write(encode(data));
    setTimeout(function() { console.log("[TEST]", "complete"); }, 1000);
}
window.onload = function()
{
    states = [ [[], []], [], [], [[], []], [], [] ];
    encoder = new TextEncoder();
    for (var i = 0; i < 4; ++i)
    {
        universe.push([]);
        for (var j = 0; j <= 512; ++j)
        {
            universe[i].push(0);
        }
    }
    for (var key in personality)
    {
        fixtures.push([key, 255]);
    }
    setInterval(refresh, 0);
    setInterval(generate, 1000);
    setInterval(interface, 10);
}
var generate = function()
{
    if ((serial != null) && (writer != null) && (!manual_override))
    {
        writer.write(encode(universe[0]));
    }
}
var refresh = function()
{
    for (var i = 0; i < fixtures.length; ++i)
    {
        states[0][0][i] = fixtures[i];
        states[0][1][i] = fixtures[i][1] * mastering_grand;
        var univ = parseInt(fixtures[i][0] / 512);
        var addr = parseInt(fixtures[i][0] % 512);
        universe[univ][addr] = parseInt(states[0][1][i]);
    }
}
var interface = function()
{
    canvas = document.getElementById("display-video");
    canvas.width = 300; canvas.height = 200;
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "#321";
    ctx.fillRect(0, 0, 300, 200);
    ctx.lineWidth = 6;
    ctx.strokeStyle = "#fda";
    ctx.shadowStyle = ctx.strokeStyle;
    ctx.shadowBlur = 10;
    ctx.strokeRect(10, 10, 280, 180);
    ctx.fillStyle = "#fda";
    ctx.font = "8pt sans-serif";
    if (video_page == 0)
    {
        ctx.fillText("___LIVE_TF___", 110, 25);
        for (var i = 0; i < states[0][0].length; ++i)
        {
            ctx.fillText(states[0][0][i], 15, 45 + (20 * i));
        }
        for (var i = 0; i < states[0][1].length; ++i)
        {
            ctx.fillText(states[0][1][i], 115, 45 + (20 * i));
        }
    }
    if (video_page == 1) { ctx.fillText("___MEMORY___", 110, 25); }
    if (video_page == 2) { ctx.fillText("___BLK_STK___", 110, 25); }
    if (video_page == 3) { ctx.fillText("___UTILS___", 110, 25); }
    if (video_page == 4) { ctx.fillText("___VIEW___", 110, 25); }
    if (video_page == 5) { ctx.fillText("___NUMBERS___", 110, 25); }

    canvas = document.getElementById("display-program-1");
    canvas.width = 300; canvas.height = 50;
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "#f33";
    ctx.font = "10pt sans-serif";
    ctx.fillText("AVOLITES QM500-TD EMULATOR", 25, 25);
    ctx.fillText("BBC BECG LO6 CMCR20 EHX86V", 25, 40);

    canvas = document.getElementById("display-program-2");
    canvas.width = 80; canvas.height = 220;
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "#f33";
    ctx.font = "10pt sans-serif";
    ctx.fillText("LIVE TF", 5, 35);
    ctx.fillText("MEMORY", 5, 65);
    ctx.fillText("BLK STK", 5, 95);
    ctx.fillText("UTILS", 5, 125);
    ctx.fillText("VIEW", 5, 155);
    ctx.fillText("NUMBERS", 5, 185);

    canvas = document.getElementById("display-program-3");
    canvas.width = 50; canvas.height = 50;
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "#f33";
    ctx.font = "10pt sans-serif";
    ctx.fillText(keypad, 25, 25);

    canvas = document.getElementById("display-program-4");
    canvas.width = 50; canvas.height = 50;
    ctx = canvas.getContext("2d");
    ctx.fillStyle = "#f33";
    ctx.font = "10pt sans-serif";
    ctx.fillText(edit, 25, 25);
}
var fader = function(event, sender)
{
    console.log(event.type, sender.id, sender.value);
    if (sender.id == "fader-mastering-1") { mastering_cue = parseFloat(sender.value) / 100; }
    if (sender.id == "fader-mastering-2") { mastering_add = parseFloat(sender.value) / 100; }
    if (sender.id == "fader-mastering-3") { mastering_swop = parseFloat(sender.value) / 100; }
    if (sender.id == "fader-mastering-4") { mastering_grand = parseFloat(sender.value) / 100; }
}
var pad = function(event, sender)
{
    console.log(event.type, sender.id, event.x, event.y);
    if (sender.id == "button-program")
    {
        var x = parseFloat(event.x - 1015) / 100;
        var y = parseFloat(event.y - 602) / 125;
        var n = -1; var d = 0;
        if ((x < 0.333) && (y < 0.25)) { n = 1; }
        else if ((x < 0.666) && (y < 0.25)) { n = 2; }
        else if (y < 0.25) { n = 3; }
        else if ((x < 0.333) && (y < 0.5)) { n = 4; }
        else if ((x < 0.666) && (y < 0.5)) { n = 5; }
        else if (y < 0.5) { n = 6; }
        else if ((x < 0.333) && (y < 0.75)) { n = 7; }
        else if ((x < 0.666) && (y < 0.75)) { n = 8; }
        else if (y < 0.75) { n = 9; }
        else if (x > 0.666) { d = 1; }
        else if (x > 0.333) { n = 0; }
        else { d = -1; }
        if (n != -1) { keypad += n.toString(); }
        if (d < 0)
        {
            clear += 1;
            if (clear > 1)
            {
                fixtures = []; states[0] = [[], []];
                clear = 0;
            }
            else { keypad = ""; }
        }
        else { clear = 0; }
        if (d > 0)
        {
            enter += 1;
            if (enter > 1)
            {
                enter = 0;
            }
            else
            {
                var found = false;
                for (var i = 0; i < fixtures.length; ++i)
                {
                    if (fixtures[i][0] == keypad) { fixtures[i][1] = edit; found = true; break; }
                }
                if (keypad == "") { keypad = ""; }
                else if (!found) { fixtures.push([parseInt(keypad), edit]); }
            }
            keypad = "";
        }
        else { enter = 0; }
    }
    if (sender.id == "wheel-program")
    {
        var y = parseFloat(event.y - 600) / 130;
        if (y < 0.5) { edit += 1; if (edit > 255) { edit = 255; } }
        else { edit -= 1; if (edit < 0) { edit = 0; } }
    }
    for (var i = 0; i < fixtures.length; ++i)
    {
        var persona = null;
        for (var key in personality)
        {
            if (key == i) { persona = personality[key]; break; }
        }
        if (sender.id == "wheel-chroma-key-red")
        {
            var d = 1;
            var y = parseFloat(event.y - 450) / 300;
            if (y > 0.5) { d = -1; }
            if (persona == "red")
            {
                fixtures[i][1] += d;
                if (fixtures[i][1] < 0) { fixtures[i][1] = 0; }
                if (fixtures[i][1] > 255) { fixtures[i][1] = 255; }
            }
        }
        if (sender.id == "wheel-chroma-key-green")
        {
            var d = 1;
            var y = parseFloat(event.y - 450) / 300;
            if (y > 0.5) { d = -1; }
            if (persona == "green")
            {
                fixtures[i][1] += d;
                if (fixtures[i][1] < 0) { fixtures[i][1] = 0; }
                if (fixtures[i][1] > 255) { fixtures[i][1] = 255; }
            }
        }
        if (sender.id == "wheel-chroma-key-blue")
        {
            var d = 1;
            var y = parseFloat(event.y - 450) / 300;
            if (y > 0.5) { d = -1; }
            if (persona == "blue")
            {
                fixtures[i][1] += d;
                if (fixtures[i][1] < 0) { fixtures[i][1] = 0; }
                if (fixtures[i][1] > 255) { fixtures[i][1] = 255; }
            }
        }
    }
}
var misc = function(event, sender)
{
    console.log("[MISC]", event.type, sender.id);
    if (sender.id == "button-program-1") { video_page = 0; }
    if (sender.id == "button-program-2") { video_page = 1; }
    if (sender.id == "button-program-3") { video_page = 2; }
    if (sender.id == "button-program-4") { video_page = 3; }
    if (sender.id == "button-program-5") { video_page = 4; }
    if (sender.id == "button-program-6") { video_page = 5; }
}
</script>
<style>
 * { box-sizing: border-box; margin: auto; font-family: sans-serif; overflow: hidden; }
 body { background: black; }
 [status] { color: white; word-wrap: break-word; white-space: pre; position: absolute; z-index: 0; }
 #status { top: 10px; left: 1510px; width: 400px; height: 800px; }
 [panel] { background: #333; border: 1px black solid; user-select: none; position: absolute; z-index: 1; }
 #panel-video-display { top: 0px; left: 600px; width: 600px; height: 400px; }
 #panel-mastering { top: 0px; left: 1200px; width: 300px; height: 400px; }
 #panel-program { top: 400px; left: 900px; width: 300px; height: 400px; }
 #panel-chroma-key { top: 400px; left: 1200px; width: 300px; height: 400px; }
 [display] { border: 1px white solid; position: absolute; z-index: 2; width: 500px; height: 100px; }
 #display-video { background: #111; top: 50px; left: 650px; height: 300px; }
 #display-program-1 { background: #311; top: 450px; left: 925px; width: 250px; height: 50px; border-radius: 10px; }
 #display-program-2 { background: #311; top: 525px; left: 925px; width: 50px; height: 225px; border-radius: 10px; }
 #display-program-3 { background: #311; top: 525px; left: 1040px; width: 50px; height: 70px; border-radius: 10px; }
 #display-program-4 { background: #311; top: 565px; left: 1125px; width: 50px; height: 30px; border-radius: 10px; }
 [fader] { appearance: slider-vertical; -webkit-appearance: slider-vertical; width: 10px; height: 130px; margin-left: 59px; position: absolute; z-index: 3; }
 #fader-mastering-1 { top: 200px; left: 1170px; }
 #fader-mastering-2 { top: 200px; left: 1260px; }
 #fader-mastering-3 { top: 200px; left: 1310px; }
 #fader-mastering-4 { top: 200px; left: 1400px; }
 [wheel] { background: black; border: 1px #555 solid; width: 20px; height: 130px; position: absolute; z-index: 4; }
 #wheel-program { top: 600px; left: 1130px; width: 40px; }
 #wheel-chroma-key-red { top: 450px; left: 1250px; width: 60px; height: 300px; background: red; }
 #wheel-chroma-key-green { top: 450px; left: 1325px; width: 60px; height: 300px; background: green; }
 #wheel-chroma-key-blue { top: 450px; left: 1400px; width: 60px; height: 300px; background: blue; }
 [button] { background: yellow; border: 1px black solid; text-align: center; user-select: none; position: absolute; z-index: 5; }
 #button-program { top: 602px; left: 1015px; width: 100px; height: 125px; }
 [misc] { background: grey; width: 10px; height: 20px; position: absolute; z-index: 12; }
 #button-program-1 { top: 550px; left: 985px; }
 #button-program-2 { top: 580px; left: 985px; }
 #button-program-3 { top: 610px; left: 985px; }
 #button-program-4 { top: 640px; left: 985px; }
 #button-program-5 { top: 670px; left: 985px; }
 #button-program-6 { top: 700px; left: 985px; }
 [connect] { position: absolute; top: 100px; left: 1200px; z-index: 11; }
 #baud-rate { position: absolute; top: 100px; left: 1300px; z-index: 11; }
 [editor] { position: absolute; top: 125px; left: 1200px; z-index: 11; }
 #edit-full { position: absolute; top: 125px; left: 1300px; z-index: 11; }
 [tester] { position: absolute; top: 150px; left: 1200px; z-index: 11; }
 #test-text { position: absolute; top: 150px; left: 1300px; z-index: 11; }
</style>
<svg panel id="panel-video-display">
  <text x="300" y="370" fill="white" text-anchor="middle">[VIDEO_DISPLAY]</text>
  <path d="M 20 20 l 560 0 M 20 380 l 560 0" stroke="white" stroke-width="6"></path>
</svg>
  <canvas display id="display-video" onclick="pad(event, this);"></canvas>
<svg panel id="panel-mastering">
  <text x="150" y="75" fill="cyan" text-anchor="middle" font-size="32pt">B E C G</text>
  <text x="150" y="370" fill="white" text-anchor="middle">[MASTERING]</text>
  <path d="M 20 20 l 260 0 M 20 380 l 260 0" stroke="white" stroke-width="6"></path>
</svg>
  <input fader id="fader-mastering-1" type="range" orient="vertical" value="0" oninput="fader(event, this);"></input>
  <input fader id="fader-mastering-2" type="range" orient="vertical" value="0" oninput="fader(event, this);"></input>
  <input fader id="fader-mastering-3" type="range" orient="vertical" value="0" oninput="fader(event, this);"></input>
  <input fader id="fader-mastering-4" type="range" orient="vertical" value="100" oninput="fader(event, this);"></input>
  <button connect onclick="connect();">Connect</button>
  <input id="baud-rate" type="text" value="250000"></input>
  <button editor onclick="editor();">Editor</button>
  <input id="edit-full" type="text" value="0"></input>
  <button tester onclick="tester();">Tester</button>
  <input id="test-text" type="text" value="Testing..."></input>
<svg panel id="panel-program">
  <text x="150" y="370" fill="white" text-anchor="middle">[PROGRAM]</text>
  <path d="M 20 20 l 260 0 M 20 380 l 260 0" stroke="white" stroke-width="6"></path>
</svg>
  <canvas display id="display-program-1" onclick="pad(event, this);"></canvas>
  <canvas display id="display-program-2" onclick="pad(event, this);"></canvas>
  <canvas display id="display-program-3" onclick="pad(event, this);"></canvas>
  <canvas display id="display-program-4" onclick="pad(event, this);"></canvas>
  <div wheel id="wheel-program" onclick="pad(event, this);"></div>
  <button misc id="button-program-1" onclick="misc(event, this);"></button>
  <button misc id="button-program-2" onclick="misc(event, this);"></button>
  <button misc id="button-program-3" onclick="misc(event, this);"></button>
  <button misc id="button-program-4" onclick="misc(event, this);"></button>
  <button misc id="button-program-5" onclick="misc(event, this);"></button>
  <button misc id="button-program-6" onclick="misc(event, this);"></button>
  <table button id="button-program" onclick="pad(event, this);">
    <tr><td>1</td><td>2</td><td>3</td></tr>
    <tr><td>4</td><td>5</td><td>6</td></tr>
    <tr><td>7</td><td>8</td><td>9</td></tr>
    <tr><td><</td><td>0</td><td>></td></tr>
  </table>
<svg panel id="panel-chroma-key">
  <text x="150" y="370" fill="white" text-anchor="middle">[CHROMA_KEY]</text>
  <path d="M 20 20 l 260 0 M 20 380 l 260 0" stroke="white" stroke-width="6"></path>
</svg>
  <div wheel id="wheel-chroma-key-red" onclick="pad(event, this);"></div>
  <div wheel id="wheel-chroma-key-green" onclick="pad(event, this);"></div>
  <div wheel id="wheel-chroma-key-blue" onclick="pad(event, this);"></div>
<div status id="status">
___STATUS___
* Program Panel Operational
* Video Display Panel Operational
* Chroma Key Panel Operational
* Mastering Panel Operational
* May Be Subject To Glitches
</div>
